function toggle_view() {
}

function toggle_widgets() {
    var is_opened = $('.show_widgets').toggleClass('opened').hasClass('opened');
    var height = $('#widgets-container').height();
    var wc_shift = is_opened ? -height : 40;
    var b_shift = is_opened ? height + 35 : 35;
    $('#widgets-container').stop(true, true).animate({
        bottom: wc_shift
    }, 500);
    $('.admin_wrap').stop(true, true).animate({
        paddingTop: b_shift
    }, 500)

}

function setup_admin_bar(page_id, create_url, update_url, sort_url) {
    $('body').addClass('admin_wrap');

    $(".placeholder_page").each(function() {
        var w = $(this).width();
        var h = $(this).height();
        $(this).width(w - 2);
        $(this).css('border', '1px solid red');
    });
    $(".placeholder_theme").each(function() {
        var w = $(this).width();
        var h = $(this).height();
        $(this).width(w - 2);
        $(this).css('border', '1px solid green');
    });

    var placeholders = $(".placeholder_page, .placeholder_theme");
    $("#widgets-container ul.draggable li").draggable({
        cursor: 'crosshair',
        helper: 'clone',
        revert: 'invalid',
        connectToSortable: placeholders
    });
    var oldPlaceholder, newPlaceholder, itemInMove;
    placeholders.sortable({
        revert: false,
        connectWith: placeholders,
        start: function(event, ui) {
            itemInMove = ui.item;
            oldPlaceholder = newPlaceholder = itemInMove.parent();
            console.warn('start ' + itemInMove.attr('data-id') + ' from ' + newPlaceholder.attr('id'));
        },
        stop: function(event, ui) {
            console.info('Item ' + itemInMove.attr('data-id') + ' from ' + oldPlaceholder.attr('id') + ' to ' + newPlaceholder.attr('id'));
            var split = itemInMove.attr('data-id').split('_');
            var params;

            // data-id is
            //   registered_widget_<id> - from list of registered widgets
            //   widget_<id>            - from another placeholder
            if (split.length == 3) {
                // Create
                params = 'placeholder=' + newPlaceholder.attr('id') + '&page_id=' + page_id;
                $(this).postWithAjax(create_url, params + '&reg_id=' + split.last(), function() {
                    console.log('create ' + params);
                    $(this).postWithAjax(sort_url, params + '&' + newPlaceholder.sortable('serialize', {attribute: 'data-id'}), function() {
                        console.log('sort ' + params);
                        newPlaceholder.effect("highlight", {}, 2000);
                    });
                });
            } else {
                // Move
                params = 'placeholder=' + newPlaceholder.attr('id') + '&page_id=' + page_id;
                if (newPlaceholder == oldPlaceholder) {
                    // just order was changed
                    $(this).postWithAjax(sort_url, params + '&' + newPlaceholder.sortable('serialize', {attribute: 'data-id'}),
                            function() {
                                console.log('sort - reorder ' + params);
                                newPlaceholder.effect("highlight", {}, 2000);
                            },
                            function() {
                                oldPlaceholder.sortable('cancel');
                                oldPlaceholder.effect("highlight", {color: 'red'}, 2000);
                            }
                    );
                } else {
                    // Move between placeholders
                    var url = update_url.replace('ReplaceMe', split.last());
                    console.log('sort - move');
                    // 1. Change placeholder
                    $(this).putWithAjax(url, params,
                            function() {
                                console.log('sort - sort new');
                                // 2. Sort new one
                                $(this).postWithAjax(sort_url, params + '&' + newPlaceholder.sortable('serialize', {attribute: 'data-id'}),
                                        function() {
                                            console.log('sort - sort old');
                                            // 3. Sort old one
                                            params = 'placeholder=' + oldPlaceholder.attr('id') + '&page_id=' + page_id;
                                            $(this).postWithAjax(sort_url, params + '&' + oldPlaceholder.sortable('serialize', {attribute: 'data-id'}),
                                                    function() {
                                                        newPlaceholder.effect("highlight", {}, 2000);
                                                    },
                                                    function() {
                                                        oldPlaceholder.sortable('cancel');
                                                        oldPlaceholder.effect("highlight", {color: 'red'}, 2000);
                                                    }
                                            );
                                        },
                                        function() {
                                            oldPlaceholder.sortable('cancel');
                                            oldPlaceholder.effect("highlight", {color: 'red'}, 2000);
                                        }
                                );
                            },
                            function() {
                                oldPlaceholder.sortable('cancel');
                                oldPlaceholder.effect("highlight", {color: 'red'}, 2000);
                            }
                    );
                }
            }

        },
        change: function(event, ui) {
            if (ui.sender) {
                newPlaceholder = ui.placeholder.parent();
                console.warn('placeholder change to ' + newPlaceholder.attr('id'));
            }
        }
    });
    $('.draggable, .draggable li, .placeholder_page, .placeholder_page li, .placeholder_theme, .placeholder_theme li')
            .disableSelection();
}

